<html>

<head>
    <link type="text/css" rel="stylesheet" href="tp1.css">
    <link rel="stylesheet" href="css/bulma.css">
</head>

<body>

    <div class="hero-body">
        <div class="container has-text-centered">
            <form method="post" style="width:50%;margin:0 auto;">

                <div class="field">
                    <input type="text" id="picture" name="picture" class="input" placeholder="picture" required/>
                </div>

                <div class="field">
                    <button id="buttonsubmit" type="button" class="button">Add</button>
                </div>

            </form>
        </div>
    </div>

    <div class="flex-container" id="div1">

    </div>

    <div class="center">
        <div>
            <a class="button is-primary" href="#" onclick="javascript:getPage();">Load more</a>
        </div>
    </div>
</body>

</html>

<script src='fetch.js'></script>
<script>
    var page = 0;

    function getPage() {
        page++;
        if (page == 1)
            request = 'http://localhost:4242/api/pictures?amount=20';
        else {
            var cursor = 20 * (page - 1) - 1;
            request = 'http://localhost:4242/api/pictures?cursor=' + cursor + '&amount=20';
        }

        fetch(request)
            .then((r) => r.json())
            .then((d) => {
                console.log(d);
                var currentdiv = document.getElementById("div1");
                var fragment = document.createDocumentFragment();
                for (i = 0; i < d.length; i++) {
                    var elt = d[i];
                    var div = document.createElement("div");
                    div.className = "flex-item";
                    div.addEventListener('click', () => {
                        fetch('http://localhost:4242/api/pictures/' + elt.index, {
                            method: 'DELETE'
                        }).then((response) => {
                            if (response.status == 200)
                                location.reload();
                        });
                    });

                    var img = document.createElement("img");
                    img.src = elt.picture;

                    var text = document.createTextNode(elt.index);
                    div.appendChild(img);
                    div.appendChild(text);
                    fragment.appendChild(div);
                }
                currentdiv.append(fragment);
            });
    }

    function intitialize() {
        let btn = document.getElementById("buttonsubmit");
        btn.addEventListener('click', () => {
            const picture = document.getElementById("picture");
            const petittest = picture.value;
            var truc = {
                picture: petittest
            };
            fetch('http://localhost:4242/api/pictures', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(truc)
            }).then((response) => {
                if (response.status == 200)
                    location.reload();
            });
        })
    }
    intitialize();
    getPage();
</script>